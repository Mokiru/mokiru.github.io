---
title: Garbage First Garbage Collector Tuning
date: 2025-10-12 20:00:00 +0800
categories: [Java, GC]
tags: [study]     # TAG names should always be lowercase
author: momochi
# authors: [xx,xx]
description: 介绍G1GC评估、分析、性能调优和调试
comments: true # 评论
pin: false # top 
math: true
---

## G1GC

G1 垃圾回收器（Garbage-First Garbage Collector，简称 G1 GC）是 Java HotSpot 虚拟机（JVM）中一种面向服务器、低暂停时间的分代垃圾回收器。G1 GC 通过并发与并行阶段相结合的方式，力求达成目标暂停时间并维持良好的吞吐量。当 G1 GC 判定需要执行垃圾回收时，它会优先回收包含存活数据最少的区域（即“垃圾优先”原则）。

G1GC通过下面三个操作实现自动内存管理：
- 新对象放入年轻代，并将“老化”的对象晋升到老年代
- 通过并发（并行）标记阶段，找出老年代中的存活对象。JVM会在Java堆总占用率超过默认阈值时触发标记标记阶段
- 通过并行复制方式对存活对象进行压缩，从而回收空闲内存

G1 GC 是一种区域化（regionalized）且分代的垃圾回收器，这意味着 Java 对象堆（heap）被划分为若干个大小相等的区域（region）。JVM 启动时会设置区域大小，区域尺寸根据堆大小不同，范围在 1 MB 到 32 MB 之间，目标是使区域总数不超过 2048 个。Eden 区、Survivor 区和老年代均为这些区域的逻辑集合，彼此之间并不连续。

G1 GC 设定了一个暂停时间目标（软实时目标），并努力达成该目标。在年轻代回收期间，G1 GC 会动态调整年轻代（Eden 和 Survivor 区的大小）以满足软实时目标；在混合回收（Mixed GC）期间，G1 GC 会根据混合回收的目标次数、堆中各区域的存活对象比例以及整体可接受的堆浪费百分比，动态调整每次回收的老年代区域数量。

G1 GC 通过增量式并行复制，将一个或多个区域集（称为回收集，Collection Set，简称 CSet）中的存活对象复制到新的区域，从而实现压缩并减少堆碎片。其目标是在不超出暂停时间目标的前提下，优先回收可回收空间最多的区域（即“垃圾优先”原则），以尽可能多地释放堆空间。

G1 GC 使用独立的“记忆集”（Remembered Sets，简称 RSets）来跟踪指向各区域的引用。独立的 RSets 使得区域可以被并行且独立地回收，因为只需扫描目标区域自身的 RSet 即可获取所有指向该区域的引用，而无需扫描整个堆。G1 GC 使用写后屏障（post-write barrier）来记录堆的变化并更新 RSets。

## 垃圾回收阶段

除了由“疏散暂停”（evacuation pause）构成的 Stop-The-World（STW）年轻代回收和混合回收外，G1 GC 还包含并行、并发及多阶段的标记周期。G1 GC 采用“原始快照”（Snapshot-At-The-Beginning，SATB）算法，在标记周期开始时对堆中存活对象集合进行快照。该存活对象集合包括快照中的存活对象以及标记周期开始后新分配的对象。G1 GC 的标记算法使用写前屏障（pre-write barrier）来记录并标记属于逻辑快照的对象。

## 年轻代垃圾回收（Young GC）

G1 GC 的大多数对象分配请求都来自 Eden 区域集。在一次年轻代垃圾回收中，G1 GC 会同时回收当前的 Eden 区域和上一次 GC 后的 Survivor 区域。Eden 和 Survivor 区域中的存活对象会被复制（即“疏散”）到一组新的区域中。具体目标区域取决于对象的年龄：若对象已足够“老”，则会被晋升（promoted）到老年代区域；否则，会被疏散到 Survivor 区域，并纳入下一次年轻代或混合回收的 CSet 中。

## 混合垃圾回收（Mixed GC）

当并发标记周期成功完成后，G1 GC 会从仅执行年轻代回收切换为执行混合回收。在混合回收中，G1 GC 会将部分老年代区域加入到待回收的 Eden 和 Survivor 区域集中。具体加入多少老年代区域，由若干参数控制（详见后文“驯服混合 GC”部分）。在经过若干次混合回收、成功回收足够多的老年代区域后，G1 GC 会重新回到仅执行年轻代回收的状态，直到下一次标记周期完成。

## 标记周期的各个阶段

标记周期包含以下阶段：

- 初始标记阶段（Initial Mark）：G1 GC 在此阶段标记根对象。该阶段附带在一次普通的 STW 年轻代回收中执行。
- 根区域扫描阶段（Root Region Scanning）：G1 GC 扫描初始标记阶段的 Survivor 区域，查找指向老年代的引用，并标记被引用的对象。该阶段与应用程序并发执行（非 STW），且必须在下一次 STW 年轻代回收开始前完成。
- 并发标记阶段（Concurrent Marking）：G1 GC 在整个堆中查找可达（存活）对象。该阶段与应用程序并发执行，可被 STW 年轻代回收中断。
- 再标记阶段（Remark）：该阶段为 STW 操作，用于完成标记周期。G1 GC 会清空 SATB 缓冲区、追踪未访问的存活对象，并执行引用处理。
- 清理阶段（Cleanup）：作为最后一个阶段，G1 GC 执行 STW 的统计和 RSet 清理操作。在统计过程中，G1 GC 会识别完全空闲的区域以及混合回收的候选区域。清理阶段部分操作是并发的，例如重置并释放空区域回空闲列表。

## 重要默认参数

G1 GC 是一种自适应垃圾回收器，默认参数已使其在无需修改的情况下高效运行。以下是关键选项及其默认值（适用于最新版 Java HotSpot VM，build 24）。可通过在 JVM 命令行中修改以下选项，根据应用性能需求对 G1 GC 进行适配与调优。

-XX:G1HeapRegionSize=n
设置 G1 区域大小。该值必须是 2 的幂，范围为 1MB 到 32MB。目标是根据最小堆大小，使区域总数约为 2048 个。
- `-XX:MaxGCPauseMillis=200`设置期望的最大暂停时间目标。默认值为 200 毫秒。该值不会随堆大小自动调整。
- `-XX:G1NewSizePercent=5`设置年轻代最小占比（占整个堆的百分比）。默认为 5%。此为实验性参数（需先解锁实验性 VM 选项）。该参数替代了 -XX:DefaultMinNewGenPercent。Java HotSpot VM build 23 不支持此参数。
- `-XX:G1MaxNewSizePercent=60`设置年轻代最大占比。默认为 60%。此为实验性参数。该参数替代了 `-XX:DefaultMaxNewGenPercent`。Java HotSpot VM build 23 不支持此参数。
- `-XX:ParallelGCThreads=n`设置 STW 工作线程数。若逻辑处理器数 ≤ 8，则 n 等于逻辑处理器数；若 > 8，则 n 约为逻辑处理器数的 5/8。对于大型 SPARC 系统，n 可设为逻辑处理器数的约 5/16。
- `-XX:ConcGCThreads=n`设置并发标记线程数。n 约为 ParallelGCThreads 的 1/4。
- `-XX:InitiatingHeapOccupancyPercent=45`设置触发并发标记周期的堆占用率阈值。默认为整个 Java 堆的 45%。
- `-XX:G1MixedGCLiveThresholdPercent=65`设置老年代区域被纳入混合回收的存活率阈值。默认为 65%。此为实验性参数，替代了 
- `-XX:G1OldCSetRegionLiveThresholdPercent`。Java HotSpot VM build 23 不支持。
- `-XX:G1HeapWastePercent=10`设置可接受的堆浪费百分比。当可回收空间比例低于此值时，JVM 不会启动混合回收。默认为 10%。Java HotSpot VM build 23 不支持。
- `-XX:G1MixedGCCountTarget=8`设置一次标记周期后，期望通过多少次混合回收来清理满足 G1MixedGCLiveThresholdPercent 条件的老年代区域。默认为 8 次。混合回收的目标是控制在此次数内完成。Java HotSpot VM build 23 不支持。
- `-XX:G1OldCSetRegionThresholdPercent=10`设置单次混合回收中最多可回收的老年代区域占比（占整个堆）。默认为 10%。Java HotSpot VM build 23 不支持。
- `-XX:G1ReservePercent=10`设置保留内存百分比，用于降低“to-space”溢出风险。默认为 10%。调整此值时，应同步调整总堆大小。Java HotSpot VM build 23 不支持。

## 如何解锁实验性VM参数

要修改实验性参数，必须先显示解锁。方法是在命令行中、任何实验性参数之前添加`-XX:+UnlockExperimentalVMOptions`。例如：

```bash
java -XX:+UnlockExperimentalVMOptions -XX:G1NewSizePercent=10 -XX:G1MaxNewSizePercent=75 G1test.jar
```

## 调优建议

在评估和精细调优 G1 GC 时，请牢记以下建议：

- 年轻代大小：避免使用 -Xmn 或 -XX:NewRatio 等选项显式设置年轻代大小。固定年轻代大小会覆盖 G1 的暂停时间目标。
- 暂停时间目标：在评估或调优任何 GC 时，始终存在延迟与吞吐量的权衡。G1 GC 是一种具有均匀暂停时间的增量式回收器，但会给应用线程带来更高开销。G1 GC 的吞吐目标是 90% 应用时间 + 10% GC 时间；相比之下，HotSpot 的吞吐量回收器（Throughput Collector）目标是 99% 应用时间 + 1% GC 时间。因此，若以吞吐量为目标评估 G1 GC，应适当放宽暂停时间目标。过于激进的暂停目标意味着您愿意接受更高的 GC 开销，这会直接影响吞吐量。若以延迟为目标，则设定期望的（软）实时目标，G1 GC 会尽力满足，但吞吐量可能因此下降。
- 驯服混合垃圾回收：调优混合回收时，可尝试调整以下参数（详见“重要默认参数”）：
    - `-XX:InitiatingHeapOccupancyPercent`：调整标记触发阈值；
    - `-XX:G1MixedGCLiveThresholdPercent` 与 `-XX:G1HeapWastePercent`：影响混合回收的决策；
    - `-XX:G1MixedGCCountTarget` 与 `-XX:G1OldCSetRegionThresholdPercent`：调整老年代区域的 CSet。

## 溢出/耗尽日志消息

当日志中出现 “to-space overflow” 或 “to-space exhausted” 消息时，表示 G1 GC 没有足够的内存用于 Survivor 对象或晋升对象（或两者皆无），且 Java 堆已达到最大值，无法扩展。示例日志：

```bash
924.897: [GC pause (G1 Evacuation Pause) (mixed) (to-space exhausted), 0.1957310 secs]
```

```bash
924.897: [GC pause (G1 Evacuation Pause) (mixed) (to-space overflow), 0.1957310 secs]
```

缓解方法包括：

- 增大 `-XX:G1ReservePercent`（并相应增大总堆大小），以增加 “to-space” 的保留内存；
- 降低 `-XX:InitiatingHeapOccupancyPercent`，使标记周期更早启动；
- 增大 `-XX:ConcGCThreads`，增加并发标记线程数。

## 巨型对象（Humongous Objects）与巨型分配

在 G1 GC 中，任何超过区域大小一半的对象均被视为“巨型对象”（Humongous Object）。这类对象会直接在老年代中分配到“巨型区域”（Humongous Region）。巨型区域是一组连续的区域，其中第一个区域标记为 StartsHumongous，后续区域标记为 ContinuesHumongous。

在分配任何巨型区域前，G1 会检查是否需要启动并发标记周期。

死亡的巨型对象会在标记周期结束时的清理阶段（或 Full GC 期间）被释放。

为减少复制开销，巨型对象不会参与任何疏散暂停。Full GC 会在原地对巨型对象进行压缩。

由于每个 StartsHumongous 与 ContinuesHumongous 区域组仅包含一个巨型对象，对象末尾到其所占最后一个区域末尾之间的空间将无法使用。对于略大于区域大小整数倍的对象，这种未使用空间可能导致堆碎片化。

如果您观察到因巨型分配而连续触发并发标记周期，且这些分配导致老年代碎片化，请尝试增大 `-XX:G1HeapRegionSize`，使原先的巨型对象不再被视为巨型对象，从而走常规分配路径。

## 结论

G1 GC 是一种区域化、并行-并发、增量式的垃圾回收器，相比其他 HotSpot GC，能提供更可预测的暂停时间。其增量特性使 G1 GC 能够在大堆场景下依然提供合理的最坏情况响应时间。G1 GC 的自适应能力只需您在 JVM 命令行中指定最大软实时暂停时间目标，以及 Java 堆的期望最大和最小尺寸即可。